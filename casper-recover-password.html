this.$.new_password<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-recover-password.
  -
  - casper-recover-password is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-recover-password  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-recover-password.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-socket/casper-socket.html">
<link rel="import" href="../casper-icons/casper-icons.html">
<link rel="import" href="../casper-button/casper-button.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">

<!--
`casper-recover-password`


@demo demo/index.html
-->
<dom-module id="casper-recover-password">
  <template>
    <style>
      :host {
        display: block;
        tabindex: -1;
        margin-bottom: 20px;
      }

      paper-input, paper-checkbox {
        display: block;
      }

      paper-checkbox {
        margin-top: 12px;
      }

      paper-input {
        width: 100%;
      }

      #spin {
        width: 16px;
        height: 16px;
        display: none;
        padding-right: 6px;
        --paper-spinner-color: #ccc;
      }

      #spin[active] {
        display: inline-flex;
      }

      casper-button{
        margin-right: 0;
      }

      #submitButton {
        /* background-color: #101010; */
      }

      #toast {
        --paper-toast-background-color: #f12424;
        --paper-toast-color: white;
        width: 100%;
        font-weight: bold;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
      }

      #toast[success]{
        --paper-toast-background-color: #4a9a4a;
        --paper-toast-color: white;
      }

      .user_actions a {
        text-align: center;
        color: var(--primary-color);
        text-decoration: none;
        display: none;
      }

      .user_actions a:hover {
        text-decoration: underline;
      }

      #forget_button {
        visibility: hidden;
      }

      .buttons {
        margin-top: 16px;
      }

      #redirect{
        display: none;
        line-height: 36px;
        text-align: center;
        background-color: #e8e8e8;
        border-radius: 3px;
        color: var(--primary-color);
      }

      #redirect a {
        text-decoration: underline;
        color: var(--primary-color);
      }

    </style>
      <casper-socket id="socket" tube-prefix="[[tubePrefix]]" cookie-domain=[[cookieDomain]]></casper-socket>
      <paper-input disabled value="[[user_email]]" id="email" name="email" label="Correio electrónico" tabindex="1"
                   auto-validate autocomplete="email" minlength="4">
      </paper-input>

      <paper-input id="new_password" name="new_password" label="Nova Senha" type="password" tabindex="2"
                   auto-validate autocomplete="password" minlength="4" autofocus>
      </paper-input>

      <paper-input id="new_password_confirmation" name="new_password_confirmation" label="Repetir nova senha" type="password" tabindex="3"
                   auto-validate autocomplete="password" minlength="4">
      </paper-input>

      <div class="buttons">
        <casper-button id="submitButton" tabindex="5" on-tap="_submitNewPassword">
          <a>Definir nova senha</a>
        </casper-button>

        <div id='redirect'>Irá ser redirecionado para a <a href="">página de login <span>(➜)</span></a></div>
      </div>

    <paper-toast id="toast" duration="2000">
      <iron-icon id="closeToast"  on-tap="_hideToast" icon="casper-icons:cancel"/></iron-icon>
    </paper-toast>
  </template>

  <script>

    CasperHelper = {}
    CasperHelper.getParams = function(url){
        var regex = /[?&]([^=#]+)=([^&#]*)/g,
            params = {},
            match;
        while(match = regex.exec(url)) {
            params[match[1]] = match[2];
        }
        return params;
    }

    class CasperRecoverPassword extends Polymer.Element {

      static get is () {
        return 'casper-recover-password';
      }

      static _b64EncodeUnicode (str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
        function toSolidBytes(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }

      static get properties () {
        return {
          /** How long should we wait for the server to respond */
          timeout: {
            type: Number,
            value: 10
          },
          /** Prefix for the beanstalk tube names */
          tubePrefix: {
            type: String,
            value: 'casper'
          },
          /** Domain used by the cookie, important when using a cluster */
          cookieDomain: {
            type: String,
            value: undefined
          }
        };
      }

      ready () {
        super.ready();
        // this.addEventListener('casper-signed-in', e => this._onCasperSignedIn(e));
        // this.addEventListener('casper-signed-out', e => this._onCasperSignedOut(e));
        // this.addEventListener('casper-forbidden', e => this._onCasperForbidden());
        // this.addEventListener('casper-disconnected', e => this._onCasperDisconnected());
        this.$.new_password.addEventListener('keydown',                       e => this._onKeyDown(e));
        this.$.new_password_confirmation.addEventListener('keydown',          e => this._onKeyDown(e));
        this.$.new_password.addEventListener('focused-changed',               e => this._onFocusChange(e));
        this.$.new_password_confirmation.addEventListener('focused-changed',  e => this._onFocusChange(e));
        this._resetValidation();
      }


      connectedCallback () {
        super.connectedCallback();
        this.$.toast.fitInto = this.parentElement;
        this.$.socket.validateSession();


        try {
          var url_parameters = CasperHelper.getParams(document.location.href);
          this.jwt = url_parameters.s;
          var jwt_parsed = JSON.parse(atob(url_parameters.s.split(".")[1]));
          this.user_email = jwt_parsed.job.payload.email;
        } catch (e) {
          debugger
        }

        if( new Date(jwt_parsed.exp*1000) - new Date() < 0 ) {
          this._openToast('Expired Link');
        }

      }

      disconnectedCallback () {
        super.disconnectedCallback();
        this.$.socket.disconnect();
      }

      _submitNewPassword (event) {
        var new_password_test = this.$.new_password.invalid || this.$.new_password.value === undefined || this.$.new_password.value.length === 0;
        var new_password_confirmation_test = this.$.new_password_confirmation.invalid || this.$.new_password_confirmation.value === undefined || this.$.new_password_confirmation.value.length === 0;
        var not_match = this.$.new_password.value != this.$.new_password_confirmation.value;

        if ( new_password_test || new_password_confirmation_test || not_match) {

          if(not_match){
            this._openToast('As senhas que introduziu não coincidem');
            return;
          }

          if(new_password_test){
            this.$.new_password.invalid = true;
            this.$.new_password.focus();
          }

          if(new_password_confirmation_test){
            this.$.new_password_confirmation.invalid = true;
            this.$.new_password_confirmation.focus();
          }

          this.$.submitButton.submitting(false);
          return;
        }else{
          this._lockUi();
          this._sendToRemote(event.target);
        }

        event.preventDefault();
      }


      _sendToRemote (target) {

        var scope = {
          container: this,
          event: target
        }

        var extra_params = {
          password: btoa(this.$.new_password.value),
          password_confirmation: btoa(this.$.new_password_confirmation.value)
        }

        var xhr = new XMLHttpRequest();
        var response = null;

        xhr.open("POST", '/jobs', true);
        xhr.setRequestHeader("Content-type",            "application/text");
        xhr.setRequestHeader("Accept",                  "application/json");
        xhr.setRequestHeader("Casper-Extra-Job-Params", CasperRecoverPassword._b64EncodeUnicode(JSON.stringify(extra_params)));

        scope.event.submitting(true);

        xhr.onprogress = function (event) {
          scope.event.progress = event.loaded;
        }.bind(scope);

        xhr.onreadystatechange = function() {
          var delay = this.noDelayResponse ? 0 : 2000;
          if (xhr.readyState == XMLHttpRequest.DONE) {
            switch (xhr.status) {
              case 200:
                var response_parse = JSON.parse(xhr.response)
                scope.event.progress = 100;
                this.event.submitting(false);
                scope.container._unlockUi();

                if(response_parse.success == false){
                  scope.container._showError('Email não encontrado.');
                }else{
                  scope.container._showSuccess('Senha redefinida com sucesso');

                  // _saveSessionCookie
                  scope.container.$.socket._saveSessionCookie(response_parse.access_token);
                  scope.container._redirect(response_parse.url);
                }

                break;
              case 409:
              case 500:
                this.event.submitting(false);
                scope.container._unlockUi();
                break;
              default:
                this.event.submitting(false);
                scope.container._unlockUi()
            }
          }
        }.bind(scope);

        xhr.send(this.jwt);
      }

      _redirect (url) {
        setTimeout(function(){
          window.location = url;
        }, 2000)

      }

      _openToast(message) {
        this.$.toast.text = message;
        this.$.toast.open();
      }

      _showSuccess (message) {
        this.$.toast.setAttribute("success", "");
        this._openToast(message);
        this._unlockUi();
      }

      _showError (message) {
        this.$.toast.removeAttribute("success");
        this.$.email.invalid = false;
        this.$.new_password.invalid = false;
        this._openToast(message);
        this._unlockUi();
      }

      _showInputError (message) {
        this._hideToast();
        this.$.email.errorMessage = message;
        this.$.new_password.errorMessage = '';
        this.$.email.invalid = true;
        this.$.new_password.invalid = true;
        this._unlockUi();
      }

      _lockUi () {
        this._hideToast();
        this.$.email.disabled = true;
        this.$.new_password.disabled = true;
        this.$.new_password_confirmation.disabled = true;
        this.$.submitButton.submitting(true);
      }

      _unlockUi () {
        this.$.new_password.disabled = false;
        this.$.new_password_confirmation.disabled = false;
        this.$.socket.disconnect();
        this.$.submitButton.submitting(false);
      }

      _hideToast () {
        this.$.toast.close();
      }

      _onKeyDown (event) {
        if ( event.keyCode === 13 ) {
          if ( this.$.new_password.focused || this.$.new_password_confirmation.focused ) {
            this.$.submitButton.click();
          }
        } else {
          this._resetValidation();
        }
      }

      _resetValidation () {
        this.$.email.invalid = false;
        this.$.new_password.invalid = false;
        this.$.new_password.errorMessage = "Senha demasiado curta";
        this.$.new_password_confirmation.errorMessage = "Senha demasiado curta";
      }

      _onFocusChange (event) {
        if ( event.detail.value && (event.target.id === 'password' || event.target.id === 'email') ) {
          this._hideToast();
        }
      }

      _onCasperForbidden () {
        this._showInputError("Senha ou email errados"); // Invalid email or password");
        this.$.new_password.value = '';
        this.$.new_password.invalid = true;
        this.$.new_password.focus();
      }

      _onCasperDisconnected () {
        if ( this._signInTimer ) {
          this._showError("Servidor Indisponível, por favor tente mais tarde"); // Server unavailable, try latter;
        }
      }

      _onCasperSignedOut () {
        this._unlockUi();
      }
    }

    window.customElements.define(CasperRecoverPassword.is, CasperRecoverPassword);
  </script>
</dom-module>
