<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-login.
  -
  - casper-login is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-login  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-login.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-socket/casper-socket.html">
<link rel="import" href="../casper-icons/casper-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">

<!--
`casper-login`


@demo demo/index.html
-->
<dom-module id="casper-login">
  <template>
    <style>
      :host {
        display: block;
        tabindex: -1;
        margin-bottom: 20px;
      }

      paper-input, paper-checkbox {
        display: block;
      }

      paper-checkbox {
        margin-top: 12px;
      }

      paper-input {
        width: 100%;
      }

      #spin {
        width: 16px;
        height: 16px;
        display: none;
        padding-right: 6px;
        --paper-spinner-color: #ccc;
      }

      #spin[active] {
        display: inline-flex;
      }

      #signIn {
        background-color: #101010;
        color: white;
        margin: 15px 10px 0px 0px;
      }

      #signIn[disabled] {
        background-color: #808080;
        color: #ccc;
      }

      #toast {
        --paper-toast-background-color: red;
        --paper-toast-color: white;
        width: 100%;
        font-weight: bold;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
      }

      a {
        color: var(--primary-color);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }
    </style>

    <casper-socket id="socket" tube-prefix="[[tubePrefix]]" cookie-domain=[[cookieDomain]]></casper-socket>
    <paper-input id="email" name="email" label="Correio electrónico" tabindex="1"
                 auto-validate autocomplete="email" minlength="4" autofocus>
    </paper-input>
    <paper-input id="password" name="password" label="Senha" type="password" tabindex="2"
                 auto-validate autocomplete="password" minlength="6">
    </paper-input>
    <paper-checkbox id="remember" tabindex="4">Gravar dados de entrada</paper-checkbox>
    <paper-button id="signIn" tabindex="5" on-click="_signIn">
      <paper-spinner-lite id="spin"></paper-spinner-lite>ENTRAR
    </paper-button>
    <a href='#' tabindex="-1">Esqueceu-se da sua senha?</a>
    <paper-toast id="toast" duration="5000">
      <iron-icon id="closeToast"  on-tap="_hideToast" icon="casper-icons:cancel"/></iron-icon>
    </paper-toast>
  </template>

  <script>
    class CasperLogin extends Polymer.Element {

      static get is () {
        return 'casper-login';
      }

      static get properties () {
        return {
          /** How long should we wait for the server to respond */
          timeout: {
            type: Number,
            value: 10
          },
          /** Prefix for the beanstalk tube names */
          tubePrefix: {
            type: String,
            value: 'casper'
          },
          /** Domain used by the cookie, important when using a cluster */
          cookieDomain: {
            type: String,
            value: undefined
          }
        };
      }

      ready () {
        super.ready();
        this.addEventListener('casper-signed-in', e => this._onCasperSignedIn(e));
        this.addEventListener('casper-signed-out', e => this._onCasperSignedOut(e));
        this.addEventListener('casper-forbidden', e => this._onCasperForbidden());
        this.addEventListener('casper-disconnected', e => this._onCasperDisconnected());
        this.$.email.addEventListener('keydown', e => this._onKeyDown(e));
        this.$.password.addEventListener('keydown', e => this._onKeyDown(e));
        this.$.email.addEventListener('focused-changed', e => this._onFocusChange(e));
        this.$.password.addEventListener('focused-changed', e => this._onFocusChange(e));
        this._resetValidation();
      }

      connectedCallback () {
        super.connectedCallback();
        this.$.toast.fitInto = this.parentElement;
        this._lockUi();
        this._signInTimer = setTimeout(() => this._showError('Tempo máximo de espera ultrapassado, p.f. tente mais tarde'), this.timeout * 1000);
        this.$.socket.validateSession();
      }

      disconnectedCallback () {
        super.disconnectedCallback();
        this.$.socket.disconnect();
      }

      _signIn () {
        if ( this.$.email.invalid || this.$.email.value === undefined || this.$.email.value.length === 0 ) {
          this.$.email.invalid = true;
          this.$.email.focus();
          return;
        }
        if ( this.$.password.invalid || this.$.password.value === undefined || this.$.password.value.length === 0 ) {
          this.$.password.invalid = true;
          this.$.password.focus();
          return;
        }
        this._lockUi();
        this.$.spin.active = true;
        this._hideToast();
        window.localStorage.setItem('casper-remember-me', this.$.remember.checked ? 'true' : 'false' );
        this.$.socket.signIn(this.$.email.value, btoa(this.$.password.value), this.timeout);
        this._signInTimer = setTimeout(() => this._showError('Tempo máximo de espera ultrapassado, p.f. tente mais tarde.'), this.timeout * 1000);
      }

      _showError (message) {
        this.$.email.invalid = false;
        this.$.password.invalid = false;
        this.$.toast.text = message;
        this.$.toast.open();
        this._unlockUi();
      }

      _showInputError (message) {
        this._hideToast();
        this.$.email.errorMessage = message;
        this.$.password.errorMessage = '';
        this.$.email.invalid = true;
        this.$.password.invalid = true;
        this._unlockUi();
      }

      _lockUi () {
        this._hideToast();
        this.$.email.disabled = true;
        this.$.password.disabled = true;
        this.$.remember.disabled = true;
        this.$.signIn.disabled =true;
      }

      _unlockUi () {
        clearTimeout(this._signInTimer);
        this._signInTimer = undefined;
        this.$.email.disabled = false;
        this.$.password.disabled = false;
        this.$.remember.disabled = false;
        this.$.signIn.disabled = false;
        this.$.socket.disconnect();
        this.$.spin.active = false;
      }

      _hideToast () {
        this.$.toast.close();
      }

      _onKeyDown (event) {
        if ( event.keyCode === 13 ) {
          if ( this.$.password.focused ) {
            this._signIn();
          } else if ( this.$.email.focused ) {
            this.$.password.focus();
          }
        } else {
          this._resetValidation();
        }
      }

      _resetValidation () {
        this.$.email.invalid = false;
        this.$.password.invalid = false;
        this.$.email.errorMessage ="Email demasiado curto";
        this.$.password.errorMessage ="Senha demasiado curta";
      }

      _onFocusChange (event) {
        if ( event.detail.value && (event.target.id === 'password' || event.target.id === 'email') ) {
          this._hideToast();
        }
      }

      _onCasperForbidden () {
        this._showInputError("Senha ou email errados"); // Invalid email or password");
        this.$.password.value = '';
        this.$.password.invalid = true;
        this.$.password.focus();
      }

      _onCasperDisconnected () {
        if ( this._signInTimer ) {
          this._showError("Servidor Indisponível, por favor tente mais tarde"); // Server unavailable, try latter;
        }
      }

      _onCasperSignedIn (event) {
        let route = '/';

        if ( this.$.remember.checked ) {
          window.localStorage.setItem('casper-user-email', this.$.email.value );
        }
        clearTimeout(this._signInTimer);
        this._signInTimer = undefined;
        if ( event.detail &&  event.detail.route ) {
          route = event.detail.route;
        }
        if ( event.detail && event.detail.role ) {
          window.localStorage.setItem('casper-role', event.detail.role);
        } else {
          window.localStorage.removeItem('casper-role');
        }
        window.location = route;
      }

      _onCasperSignedOut () {
        this._unlockUi();
      }
    }

    window.customElements.define(CasperLogin.is, CasperLogin);
  </script>
</dom-module>
