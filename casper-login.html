<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-login.
  -
  - casper-login is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-login  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-login.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-socket/casper-socket.html">
<link rel="import" href="../casper-icons/casper-icons.html">
<link rel="import" href="../casper-button/casper-button.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">

<!--
`casper-login`


@demo demo/index.html
-->
<dom-module id="casper-login">
  <template>
    <style>
      :host {
        display: block;
        tabindex: -1;
        margin-bottom: 20px;
      }

      paper-input, paper-checkbox {
        display: block;
      }

      paper-checkbox {
        margin-top: 12px;
      }

      paper-input {
        width: 100%;
      }

      #spin {
        width: 16px;
        height: 16px;
        display: none;
        padding-right: 6px;
        --paper-spinner-color: #ccc;
      }

      #spin[active] {
        display: inline-flex;
      }

      casper-button{
        margin-right: 0;
      }

      #signIn {
        /* background-color: #101010; */
      }

      #toast {
        --paper-toast-background-color: #f12424;
        --paper-toast-color: white;
        width: 100%;
        font-weight: bold;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
      }

      #toast[success]{
        --paper-toast-background-color: #4a9a4a;
        --paper-toast-color: white;
      }

      .user_actions a {
        text-align: center;
        color: var(--primary-color);
        text-decoration: none;
        display: none;
      }

      .user_actions a:hover {
        text-decoration: underline;
      }

      #forget_button {
        visibility: hidden;
      }

      .buttons {
        margin-top: 16px;
      }

      .buttons #signIn {
        display: none;
      }

      .buttons #forgetPasswordJob {
        display: none;
      }

      .user_actions[disabled] a {
        pointer-events: none;
        cursor: default;
        opacity: 0.6;
        color: grey;
      }

    </style>
      <casper-socket id="socket" tube-prefix="[[tubePrefix]]" cookie-domain=[[cookieDomain]]></casper-socket>

      <paper-input id="email" name="email" label="Correio electrónico" tabindex="1"
                   auto-validate autocomplete="email" minlength="4" autofocus>
      </paper-input>
      <paper-input id="password" name="password" label="Senha" type="password" tabindex="2"
                   auto-validate autocomplete="password" minlength="6">
      </paper-input>
      <paper-checkbox id="remember" tabindex="4">Gravar dados de entrada</paper-checkbox>

      <div class="buttons">
        <casper-button id="signIn" tabindex="5" on-tap="_signIn">
          <a>Entrar</a>
        </casper-button>

        <casper-button id="forgetPasswordJob" tabindex="5" on-tap="_forgetPasswordJob">
          <a>Enviar-me instruções para recuperação da senha</a>
        </casper-button>
      </div>

      <div id="userAction" class="user_actions">
        <a id='forget_form' href='#' on-tap="_forgotPassword" tabindex="-1">Esqueceu-se da sua senha?</a>
        <a id='login_form'  href='#' on-tap="_signInForm"     tabindex="-1">Preencher dados de login.</a>
      </div>

    <paper-toast id="toast" duration="5000">
      <iron-icon id="closeToast"  on-tap="_hideToast" icon="casper-icons:cancel"/></iron-icon>
    </paper-toast>
  </template>

  <script>
    class CasperLogin extends Polymer.Element {

      static get is () {
        return 'casper-login';
      }

      static _b64EncodeUnicode (str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
        function toSolidBytes(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }

      static get properties () {
        return {
          /** How long should we wait for the server to respond */
          timeout: {
            type: Number,
            value: 10
          },
          /** Prefix for the beanstalk tube names */
          tubePrefix: {
            type: String,
            value: 'casper'
          },
          /** Domain used by the cookie, important when using a cluster */
          cookieDomain: {
            type: String,
            value: undefined
          }
        };
      }

      ready () {
        super.ready();

        this._boundSendToJobNotification = this._onSendToJobNotification.bind(this);

        this.addEventListener('casper-signed-in', e => this._onCasperSignedIn(e));
        this.addEventListener('casper-error',      e => this._onCasperError(e));
        this.addEventListener('casper-signed-out', e => this._onCasperSignedOut(e));
        this.addEventListener('casper-forbidden', e => this._onCasperForbidden(e));
        this.addEventListener('casper-disconnected', e => this._onCasperDisconnected(e));
        this.$.email.addEventListener('keydown', e => this._onKeyDown(e));
        this.$.password.addEventListener('keydown', e => this._onKeyDown(e));
        this.$.password.addEventListener('focused-changed', e => this._onFocusChange(e));
        this._resetValidation();
        this._showLogin();
      }

      connectedCallback () {
        super.connectedCallback();
        this.$.toast.fitInto = this.parentElement;
        this._lockUi();
        this._signInTimer = setTimeout(() => this._showError('Tempo máximo de espera ultrapassado, p.f. tente mais tarde'), this.timeout * 1000);
        this.$.socket.validateSession();
      }

      disconnectedCallback () {
        super.disconnectedCallback();
        this.$.socket.disconnect();
      }

      _showLogin() {
        this.$.signIn.style.display = 'block';
        this.$.forget_form.style.display = 'block';

        this.$.password.style.display = 'block';
        this.$.remember.style.display = 'block';

        // show/hide links
        this.$.forgetPasswordJob.style.display = 'none';
        this.$.login_form.style.display = 'none';
      }

      _showForgetPassword() {
        this.$.forgetPasswordJob.style.display = 'block';
        this.$.login_form.style.display = 'block';

        this.$.password.style.display = 'none';
        this.$.remember.style.display = 'none';

        // show/hide links
        this.$.signIn.style.display = 'none';
        this.$.forget_form.style.display = 'none';
      }

      _forgotPassword(event) {
        this._showForgetPassword()
        event.preventDefault();
      }

      _signInForm(event) {
        this._showLogin();
        event.preventDefault();
      }

      _forgetPasswordJob (event) {
        if ( this.$.email.invalid || this.$.email.value === undefined || this.$.email.value.length === 0 ) {
          this.$.email.invalid = true;
          this.$.email.focus();
          this.$.signIn.submitting(false);
          return;
        } else {
          this._lockUi();
          this._sendToJob(event.target, this.$.email.value);
        }
        event.preventDefault();
      }

      _sendToJob (target, email) {
        this.$.socket.submitJob({
            tube: 'toconline-recover-password',
            email: email
          },
          this._sendToJobResponse.bind(this), {
            ttr: 15,
            validity: 20,
            timeout: 20
          }
        );
      }

      _sendToJobResponse (response) {
        if ( response.success === true ) {
          if ( this._jobId ) {
            this.$.socket.removeEventListener(this._jobId, this._boundSendToJobNotification);
          }
          this._jobId = response.channel;
          this.$.socket.addEventListener(this._jobId, this._boundSendToJobNotification);
        }
      }

      _onSendToJobNotification (notification) {

        if ( notification.detail.status === 'completed' && notification.detail.status_code == 200 ) {

          var response = notification.detail.response;
          this.$.forgetPasswordJob.progress = 100;
          this.$.forgetPasswordJob.submitting(false);
          this._unlockUi();

          if(response.success == false){
            this._showError('Email não encontrado.');
          }else{
            this._showSuccess('Instruções enviadas por email.');
            this._showLogin();
          }
        }
      }

      _signIn (event) {
        if ( this.$.email.invalid || this.$.email.value === undefined || this.$.email.value.length === 0 ) {
          this.$.email.invalid = true;
          this.$.email.focus();
          this.$.signIn.submitting(false);
          return;
        }
        if ( this.$.password.invalid || this.$.password.value === undefined || this.$.password.value.length === 0 ) {
          this.$.password.invalid = true;
          this.$.password.focus();
          this.$.signIn.submitting(false);
          return;
        }
        this._lockUi();
        this._hideToast();
        window.localStorage.setItem('casper-remember-me', this.$.remember.checked ? 'true' : 'false' );
        this.$.socket.signIn(this.$.email.value, btoa(this.$.password.value), this.timeout, this.$.remember.checked);
        this.$.signIn.submitting(true);
        this._signInTimer = setTimeout(() => this._showError('Tempo máximo de espera ultrapassado, p.f. tente mais tarde.'), this.timeout * 1000);
      }

      _openToast (message) {
        this.$.toast.text = message;
        this.$.toast.open();
      }

      _showSuccess (message) {
        this.$.toast.setAttribute('success', '');
        this._openToast(message);
        this._unlockUi();
      }

      _showError (message) {
        this.$.toast.removeAttribute('success');
        this.$.email.invalid = false;
        this.$.password.invalid = false;
        this._openToast(message);
        this._unlockUi();
      }

      _showInputError (message) {
        this._hideToast();
        this.$.email.errorMessage = message;
        this.$.password.errorMessage = '';
        this.$.email.invalid = true;
        this.$.password.invalid = true;
        this._unlockUi();
      }

      _lockUi () {
        this._hideToast();
        this.$.email.disabled = true;
        this.$.password.disabled = true;
        this.$.remember.disabled = true;
        this.$.userAction.setAttribute('disabled', '');
      }

      _unlockUi () {
        clearTimeout(this._signInTimer);
        this._signInTimer = undefined;
        this.$.email.disabled = false;
        this.$.password.disabled = false;
        this.$.remember.disabled = false;
        this.$.socket.disconnect();
        this.$.signIn.submitting(false);
        this.$.userAction.removeAttribute('disabled');
      }

      _hideToast () {
        this.$.toast.close();
      }

      _onKeyDown (event) {
        if ( event.keyCode === 13 ) {
          if ( this.$.password.focused ) {
            this._signIn();
          } else if ( this.$.email.focused ) {
            this.$.password.focus();
          }
        } else {
          this._hideToast();
          this._resetValidation();
        }
      }

      _resetValidation () {
        this.$.email.invalid = false;
        this.$.password.invalid = false;
        this.$.email.errorMessage = 'Email demasiado curto';
        this.$.password.errorMessage = 'Senha demasiado curta';
      }

      /**
       * Focus listener for password field
       *
       * After the login error password is focused, when the focus moves out hide the tooltip
       */
      _onFocusChange (event) {
        if ( event.detail.value == false && event.target.id === 'password') {
          this._hideToast();
        }
      }

      _onCasperError (event) {
        this._showError('Ocorreu um erro de acesso inesperado, por favor tente mais tarde');
      }

      _onCasperForbidden (event) {
        this._showError('Senha ou email errados');
        this.$.password.errorMessage = 'Senha ou email errados';
        this.$.password.invalid = true;
        this.$.email.$.nativeInput.select();
        this.$.password.$.nativeInput.select();
      }

      _onCasperDisconnected (event) {
        if ( this._signInTimer ) {
          this._showError("Servidor Indisponível, por favor tente mais tarde"); // Server unavailable, try latter;
        }
      }

      _onCasperSignedIn (event) {
        let route = '/';

        if ( this.$.remember.checked ) {
          window.localStorage.setItem('casper-user-email', this.$.email.value );
        }
        clearTimeout(this._signInTimer);
        this._signInTimer = undefined;
        if ( event.detail &&  event.detail.route ) {
          route = event.detail.route;
        }
        window.location = route;
      }

      _onCasperSignedOut () {
        this._unlockUi();
      }
    }

    window.customElements.define(CasperLogin.is, CasperLogin);
  </script>
</dom-module>
